{% extends 'base.html' %}
{% block title %}FMD — Registros{% endblock %}

{% block extra_styles %}
<style>
/* Estilos locais mínimos para o wrapper FMD (seguem mesmo padrão do RFO) */
.fmd-wrapper { width: 100%; padding: 10px 18px; box-sizing: border-box; }
.fmd-content { width: 100%; max-width: none; margin: 0; padding: 0; }
.fmd-header { margin: 6px 0 8px 0; font-size: 1.6rem; font-weight: 600; }
.fmd-btns { margin-bottom: 8px; }
.fmd-iframe { display: block; width: 100%; border: 0; min-height: 640px; box-sizing: border-box; background: transparent; }
.fmd-iframe-container { padding: 0; margin: 0; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid fmd-wrapper">
  <div class="fmd-content">
    <h2 class="fmd-header">FMD — Registros</h2>

    <div class="btn-group fmd-btns" role="group" aria-label="abas fmd">
      <button type="button" class="btn btn-outline-secondary active" data-tab="registrar">Registrar</button>
      <button type="button" class="btn btn-outline-secondary" data-tab="visualizar">Visualizar</button>
    </div>

    <div id="tabs-container" class="fmd-iframe-container">
      <div id="panel-registrar" style="display:block;">
        <iframe id="iframe-registrar" class="fmd-iframe" src="/disciplinar/registrar_fmd?iframe=1" loading="eager"></iframe>
      </div>

      <div id="panel-visualizar" style="display:none;">
        <iframe id="iframe-visualizar" class="fmd-iframe" data-src="/visualizacoes/fmds?iframe=1" loading="lazy"></iframe>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  function show(tab) {
    document.querySelectorAll('[data-tab]').forEach(b=>b.classList.toggle('active', b.getAttribute('data-tab')===tab));
    ['registrar','visualizar'].forEach(name=>{
      const panel = document.getElementById('panel-'+name);
      if (!panel) return;
      panel.style.display = (name===tab) ? 'block' : 'none';
      const iframe = document.getElementById('iframe-'+name);
      if (iframe && !iframe.getAttribute('src')) {
        const s = iframe.getAttribute('data-src');
        if (s) iframe.setAttribute('src', s);
      }
    });
  }

  document.querySelectorAll('[data-tab]').forEach(b=>{
    b.addEventListener('click', function(){ show(this.getAttribute('data-tab')); });
  });

  // ajustar altura quando um iframe carregar
  ['registrar','visualizar'].forEach(name=>{
    const f = document.getElementById('iframe-'+name);
    if (!f) return;
    f.addEventListener('load', function(){
      try {
        const h = Math.max(this.contentDocument.body.scrollHeight, this.contentDocument.documentElement.scrollHeight);
        this.style.height = (h + 40) + 'px';
      } catch(e){}
    });
  });

  // ativa tab por ?tab=...
  try {
    const params = new URLSearchParams(window.location.search);
    const t = params.get('tab');
    if (t && ['registrar','visualizar'].includes(t)) {
      const iframe = document.getElementById('iframe-'+t);
      if (iframe && !iframe.getAttribute('src')) {
        const s = iframe.getAttribute('data-src');
        if (s) iframe.setAttribute('src', s);
      }
      show(t);
    }
  } catch(e){}
})();
</script>
{% endblock %}