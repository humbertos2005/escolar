{% extends 'base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/disciplinar.css') }}">
{% endblock %}

{% block content %}
<div class="main-content-inner">
    <h2>Registrar Ficha de Medida Disciplinar (FMD)</h2>

    <form method="POST" id="form-registrar-fmd" class="form-rfo" autocomplete="off">
        <!-- 1 - Notificação de Medida Disciplinar Número (sequência automática por ano) -->
        <div class="form-section">
            <h3 class="section-title"><i class="fas fa-hashtag"></i> Notificação</h3>
            <div class="form-group">
                <label>Notificação de Medida Disciplinar Nº</label>
                <input type="text" class="form-control" id="fmd_id_display" name="fmd_id_display" value="{{ fmd_id_gerado if fmd_id_gerado else '' }}" readonly>
                <input type="hidden" name="fmd_id" id="fmd_id" value="{{ fmd_id_gerado if fmd_id_gerado else '' }}">
                <small class="help-text">Número atribuído automaticamente pelo sistema (sequência por ano).</small>
            </div>
        </div>

        <!-- 2 - Aluno (autocomplete) -->
        <div class="form-section">
            <h3 class="section-title"><i class="fas fa-user-graduate"></i> Identificação do Aluno</h3>
            <div class="form-group" style="position:relative;">
                <label for="aluno_busca_fmd">Aluno (Matrícula e Nome) <span class="required">*</span></label>
                <input type="text" id="aluno_busca_fmd" name="aluno_busca_fmd" class="form-control" placeholder="Digite matrícula ou nome (3+ caracteres)..." required>
                <input type="hidden" id="aluno_id_fmd" name="aluno_id">
                <div id="aluno_autocomplete_list_fmd" class="autocomplete-items" role="listbox" aria-label="Sugestões de alunos"></div>
                <p id="aluno-info-fmd" class="info-display"></p>
            </div>

            <div class="form-group">
                <label for="data_fmd">Data da FMD <span class="required">*</span></label>
                <input type="date" id="data_fmd" name="data_fmd" class="form-control" value="{{ hoje if hoje is defined else '' }}" required>
            </div>
        </div>

        <!-- 4 e 5 - Tipo(s) de Falta e Data da falta cometida -->
        <div class="form-section">
            <h3 class="section-title"><i class="fas fa-list-alt"></i> Tipos de Falta e Datas</h3>
            <div class="form-group">
                <label>Tipo(s) de Falta <span class="required">*</span></label>
                <!-- Botões que adicionam 'pills' (permitem combinação e duplicatas se desejado) -->
                <div id="tipo-falta-buttons-fmd" style="display:flex; gap:10px; margin-bottom:10px;">
                    <button type="button" class="button tipo-adicionar-fmd" data-tipo="LEVE">LEVE</button>
                    <button type="button" class="button tipo-adicionar-fmd" data-tipo="MÉDIA">MÉDIA</button>
                    <button type="button" class="button tipo-adicionar-fmd" data-tipo="GRAVE">GRAVE</button>
                </div>
                <div id="tipo_falta_selecionadas_fmd" style="margin-bottom:8px;"></div>
                <input type="hidden" id="tipo_falta_list_fmd" name="tipo_falta_list" value="">
                <small class="help-text">Clique nas opções para adicionar. É possível adicionar o mesmo tipo mais de uma vez (ex.: LEVE/LEVE/GRAVE) ou combinar tipos diferentes.</small>
            </div>

            <div class="form-group">
                <label for="data_falta">Data da(s) Falta(s) Cometida(s)</label>
                <input type="date" id="data_falta" name="data_falta" class="form-control">
                <small class="help-text">Caso sejam várias datas, informe a principal aqui e detalhe no relato.</small>
            </div>
        </div>

        <!-- 6 - Relato das faltas -->
        <div class="form-section">
            <h3 class="section-title"><i class="fas fa-file-alt"></i> Relato da(s) Falta(s)</h3>
            <div class="form-group">
                <label for="relato_faltas">Relato da(s) Falta(s) Cometida(s)</label>
                <textarea id="relato_faltas" name="relato_faltas" class="form-control" rows="5"></textarea>
            </div>
        </div>

        <!-- 7 - Item/Descrição da Falta (multiplos lançamentos) -->
        <div class="form-section">
            <h3 class="section-title"><i class="fas fa-exclamation-circle"></i> Item(s) / Descrição da Falta</h3>
            <div class="form-group" style="position:relative;">
                <label for="falta-search-fmd">Item/Descrição da Falta</label>
                <input type="text" id="falta-search-fmd" class="form-control" placeholder="Buscar item/descrição (3+ caracteres)..." autocomplete="off">
                <div id="falta-autocomplete-list-fmd" class="autocomplete-items" role="listbox" aria-label="Sugestões de faltas"></div>
                <div id="falta-selecionadas-fmd" style="margin-top:12px;"></div>
                <input type="hidden" id="falta_disciplinar_ids_fmd" name="falta_disciplinar_ids" value="">
                <small class="help-text">Adicione um ou mais itens. O sistema grava os IDs separados por vírgula.</small>
            </div>
        </div>

        <!-- 8 - Comportamento (autocomplete) -->
        <div class="form-section">
            <h3 class="section-title"><i class="fas fa-child"></i> Comportamento / Pontuação</h3>
            <div class="form-group" style="position:relative;">
                <label for="comportamento">Comportamento</label>
                <input type="text" id="comportamento" name="comportamento" class="form-control" placeholder="Comece a digitar..." autocomplete="off">
                <div id="comportamento_autocomplete_list" class="autocomplete-items"></div>
                <input type="hidden" id="comportamento_id" name="comportamento_id" value="">
            </div>

            <!-- 9 - Pontuação (autocomplete) -->
            <div class="form-group" style="position:relative;">
                <label for="pontuacao">Pontuação</label>
                <input type="text" id="pontuacao" name="pontuacao" class="form-control" placeholder="Pontuação (autocomplete)..." autocomplete="off">
                <div id="pontuacao_autocomplete_list" class="autocomplete-items"></div>
                <input type="hidden" id="pontuacao_id" name="pontuacao_id" value="">
            </div>

            <!-- NEW:  Medida Aplicada (required) -->
            <div class="form-group">
                <label for="medida_aplicada">Medida Aplicada <span class="required">*</span></label>
                <select id="medida_aplicada" name="medida_aplicada" class="form-control" required>
                    <option value="">-- Selecione a medida aplicada --</option>
                    <option value="Advertência verbal">Advertência verbal</option>
                    <option value="Advertência escrita">Advertência escrita</option>
                    <option value="Reunião com responsável">Reunião com responsável</option>
                    <option value="Advertência pedagógica">Advertência pedagógica</option>
                    <option value="Suspensão">Suspensão</option>
                    <option value="Transferência">Transferência</option>
                    <option value="Outra">Outra (especificar)</option>
                </select>
                <input type="text" id="medida_aplicada_outra" name="medida_aplicada_outra" class="form-control mt-2" placeholder="Descreva outra medida aplicada..." style="display:none;">
                <small class="help-text">Escolha a medida aplicada. Se selecionar "Outra", descreva no campo abaixo.</small>
            </div>

            <!-- 10 - Necessidade de comparecimento -->
            <div class="form-group">
                <label>Há necessidade de comparecimento do Responsável?</label>
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="comparecimento" value="1" checked> Sim</label>
                    <label class="radio-label"><input type="radio" name="comparecimento" value="0"> Não</label>
                </div>
            </div>

            <!-- 11 - Prazo para comparecimento -->
            <div class="form-group">
                <label for="prazo_comparecimento">Prazo para comparecimento</label>
                <input type="date" id="prazo_comparecimento" name="prazo_comparecimento" class="form-control">
                <div style="margin-top:6px;">
                    <label><input type="checkbox" id="prazo_nao_ha"> Não há.</label>
                </div>
            </div>

            <!-- 12 e 13 - Circunstâncias atenuantes / agravantes (autocomplete) -->
            <div class="form-group" style="position:relative;">
                <label for="circunstancias_atenuantes">Circunstâncias Atenuantes</label>
                <input type="text" id="circunstancias_atenuantes" name="circunstancias_atenuantes" class="form-control" placeholder="Autocomplete..." autocomplete="off">
                <div id="atenuantes_autocomplete_list" class="autocomplete-items"></div>
                <input type="hidden" id="atenuantes_id" name="atenuantes_id" value="">
                <small class="help-text">Se não houver, será gravado 'Não há'.</small>
            </div>

            <div class="form-group" style="position:relative;">
                <label for="circunstancias_agravantes">Circunstâncias Agravantes</label>
                <input type="text" id="circunstancias_agravantes" name="circunstancias_agravantes" class="form-control" placeholder="Autocomplete..." autocomplete="off">
                <div id="agravantes_autocomplete_list" class="autocomplete-items"></div>
                <input type="hidden" id="agravantes_id" name="agravantes_id" value="">
                <small class="help-text">Se não houver, será gravado 'Não há'.</small>
            </div>

            <!-- 14 - Gestor (autocomplete do usuário logado sugerido) -->
            <div class="form-group" style="position:relative;">
                <label for="gestor">Gestor</label>
                <input type="text" id="gestor" name="gestor" class="form-control" placeholder="Digite para buscar usuário..." autocomplete="off" value="{{ session.get('username') }}">
                <div id="gestor_autocomplete_list" class="autocomplete-items"></div>
                <input type="hidden" id="gestor_id" name="gestor_id" value="{{ session.get('user_id') }}">
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-action btn-registrar">
                <i class="fas fa-save"></i> Registrar FMD
            </button>
            <a href="javascript:history.back()" class="btn-action btn-cancelar" role="button">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<style>
/* Minimal CSS to ensure dropdowns appear correctly */
.form-group { position: relative; }
.autocomplete-items { display: none; position: absolute; left:0; right:0; top:calc(100% + 6px); z-index:9999; background:#fff; border:1px solid #ddd; max-height:220px; overflow:auto; box-shadow:0 6px 18px rgba(0,0,0,.08); }
.autocomplete-items.show { display:block; }
.autocomplete-items div { padding:8px 10px; border-bottom:1px solid #eee; cursor:pointer; }
.autocomplete-items div:hover { background:#f6f8fa; }
.pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:16px; background:#f1f1f1; margin-right:6px; margin-bottom:6px; }
.pill .remove { cursor:pointer; color:#c0392b; font-weight:700; margin-left:6px; }
.info-display { margin-top:6px; font-size:.95em; color:#666; }
</style>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const AUTOCOMPLETE_ALUNOS_URL = "{{ url_for('disciplinar_bp.buscar_alunos_json') }}";
const AUTOCOMPLETE_FALTAS_URL = "{{ url_for('disciplinar_bp.api_faltas_busca') }}";
const AUTOCOMPLETE_COMPORTAMENTO_URL = "{{ url_for('disciplinar_bp.api_comportamentos_busca') }}";
const AUTOCOMPLETE_PONTUACAO_URL = "{{ url_for('disciplinar_bp.api_pontuacoes_busca') }}";
const AUTOCOMPLETE_CIRCUNSTANCIAS_URL = "{{ url_for('disciplinar_bp.api_pontuacoes_busca') }}";  // reutiliza pontuações
const AUTOCOMPLETE_USUARIOS_URL = "{{ url_for('disciplinar_bp.api_usuarios_busca') }}";
</script>
<script src="{{ url_for('static', filename='js/registrar_fmd.js') }}"></script>

<script>
// show/hide "outra medida" input when select changes
document.addEventListener('DOMContentLoaded', function () {
    var select = document.getElementById('medida_aplicada');
    var outra = document.getElementById('medida_aplicada_outra');
    if (!select || !outra) return;
    function toggleOutra() {
        if (select.value === 'Outra') {
            outra.style.display = 'block';
            outra.setAttribute('required', 'required');
        } else {
            outra.style.display = 'none';
            outra.removeAttribute('required');
            outra.value = '';
        }
    }
    select.addEventListener('change', toggleOutra);
    toggleOutra();
});
</script>
{% endblock %}