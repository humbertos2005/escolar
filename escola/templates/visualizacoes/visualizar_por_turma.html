{% extends 'base.html' %}
{% block content %}
<h2>Visualizar Alunos por Série/Turma</h2>
<div style="max-width:700px;margin:30px auto;">
    <form method="POST" style="display:flex;gap:20px;align-items:center;justify-content:center;background:#f7f7f7;padding:20px;border-radius:10px;">
        <div>
            <label for="serie">Série:</label>
            <select name="serie" id="serie" required>
                <option value="">Selecione...</option>
                {% for serie in series %}
                <option value="{{ serie }}" {% if serie == serie_selecionada %}selected{% endif %}>{{ serie }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="turma">Turma:</label>
            <select name="turma" id="turma" required>
                <option value="">Selecione...</option>
                {% for turma in turmas %}
                <option value="{{ turma }}" {% if turma == turma_selecionada %}selected{% endif %}>{{ turma }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="button btn-primary">Buscar</button>
    </form>
</div>
{% if alunos is defined and alunos %}
<div class="table-info">
    <p>Exibindo {{ alunos|length }} aluno(s) da Série {{ serie_selecionada }} Turma {{ turma_selecionada }}</p>
</div>
<div class="table-container" style="max-width:1100px;margin:0 auto;">
    <table class="table table-data table-full">
        <thead>
            <tr>
                <th>ID</th>
                <th>Matrícula</th>
                <th>Nome Completo</th>
                <th>Série</th>
                <th>Turma</th>
                <th>Turno</th>
                <th>Líder</th>
            </tr>
        </thead>
        <tbody>
            {% for aluno in alunos %}
            <tr>
                <td>{{ aluno.id }}</td>
                <td>{{ aluno.matricula }}</td>
                <td>{{ aluno.nome }}</td>
                <td>{{ aluno.serie }}</td>
                <td>{{ aluno.turma }}</td>
                <td>{{ aluno.turno }}</td>
                <td>
                    <button type="button" class="btn btn-warning btn-definir-lider" data-aluno-id="{{ aluno.id }}">
                        Definir como líder
                    </button>
                    {% if aluno.id == lider_id %}
                        <span style="color:green;font-weight:bold;">(Líder atual)</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% elif alunos is defined %}
<div class="empty-state">
    <i class="fas fa-users"></i>
    <p>Nenhum aluno encontrado para Série "{{ serie_selecionada }}" Turma "{{ turma_selecionada }}".</p>
</div>
{% endif %}

<script>
document.querySelectorAll('.btn-definir-lider').forEach(btn => {
    btn.addEventListener('click', function() {
        const alunoId = this.getAttribute('data-aluno-id');
        const serie = document.getElementById('serie').value;
        const turma = document.getElementById('turma').value;
        // Solicita confirmação se já houver líder na turma
        const liderAtual = "{{ lider_id }}";
        if (liderAtual && liderAtual != alunoId) {
            if (!confirm('Já existe um líder marcado para esta turma. Deseja substituir o líder atual pelo novo líder selecionado?')) {
                return; // cancela se não confirmar
            }
        }
        // Chama o backend para definir o novo líder
        fetch('/definir_lider/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                aluno_id: alunoId,
                serie: serie,
                turma: turma,
            })
        }).then(response => {
            if (response.ok) {
                location.reload(); // atualiza tela mostrando novo líder
            } else {
                alert('Erro ao marcar líder. Tente novamente.');
            }
        });
    });
});
</script>

{% endblock %}