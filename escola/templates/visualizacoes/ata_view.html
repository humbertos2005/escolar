{% extends "base.html" %}

{% block title %}Visualizar ATA nº {{ request.view_args.ata_id if request.view_args else "" }}{% endblock %}

{% block content %}
<div class="container">
  <div class="card mt-3">
    <div class="card-body">
      <div class="d-flex justify-content-between mb-3">
        <h4>ATA — Visualização</h4>
        <div>
          <button id="btn-print" class="btn btn-primary btn-sm">Imprimir</button>
          {% if ata_id %}
  <a id="btn-pdf" class="btn btn-secondary btn-sm" href="{{ url_for('visualizacoes_bp.ata_pdf', ata_id=ata_id) }}">Baixar PDF</a>
{% elif ata and ata.id %}
  <a id="btn-pdf" class="btn btn-secondary btn-sm" href="{{ url_for('visualizacoes_bp.ata_pdf', ata_id=ata.id) }}">Baixar PDF</a>
{% else %}
  <button id="btn-pdf" class="btn btn-secondary btn-sm" disabled>Baixar PDF</button>
{% endif %}
        </div>
      </div>

      <!-- documento -->
      <div id="doc" class="document-view" style="background:white; padding:30px;">
        <!-- Cabeçalho institucional -->
        <div id="doc-header" style="text-align:center; margin-bottom:20px;">
          <div style="font-weight:700;">&lt; Logotipo ESTADO &gt;</div>
          <div>&lt; ESTADO &gt;</div>
          <div>&lt; SECRETARIA &gt;</div>
          <div>&lt; COORDENAÇÃO &gt;</div>
          <div>&lt; ESCOLA &gt;</div>
        </div>

        <h5 style="text-align:center; font-weight:700; margin-top:25px;">ATA DE MEDIAÇÃO ESCOLAR Nº <span id="doc-numero"></span></h5>

        <p id="doc-body" style="margin-top:30px; line-height:1.5;">
          Aos <span id="doc-data-extenso">&lt;data por extenso&gt;</span>, compareceu na <span id="doc-escola">&lt;ESCOLA&gt;</span> o(a) Sr(a)
          <span id="doc-responsavel">&lt;RESPONSÁVEL&gt;</span>, responsável pelo(a) aluno(a)
          <span id="doc-aluno">&lt;ALUNO&gt;</span>, matriculado(a) na(s)
          <span id="doc-serie-turma">&lt;SÉRIE/TURMA&gt;</span>, para tratar do(s) seguinte(s) assunto(s):
        </p>

        <div id="doc-relato" style="min-height:200px; border:1px solid #eee; padding:12px; margin-top:10px;">
          &lt;RELATO DO GESTOR&gt;
        </div>

        <div style="margin-top:40px;">
          <div style="display:flex; gap:40px; flex-wrap:wrap;">
            <div style="flex:1; min-width:180px; text-align:center;">
              <div style="height:40px; border-bottom:1px solid #000; margin-bottom:6px;"></div>
              <div class="participant-name" data-index="0">&lt;participante 1&gt;</div>
              <div class="participant-role text-muted">&lt;cargo 1&gt;</div>
            </div>
            <div style="flex:1; min-width:180px; text-align:center;">
              <div style="height:40px; border-bottom:1px solid #000; margin-bottom:6px;"></div>
              <div class="participant-name" data-index="1">&lt;participante 2&gt;</div>
              <div class="participant-role text-muted">&lt;cargo 2&gt;</div>
            </div>
            <div style="flex:1; min-width:180px; text-align:center;">
              <div style="height:40px; border-bottom:1px solid #000; margin-bottom:6px;"></div>
              <div class="participant-name" data-index="2">&lt;participante 3&gt;</div>
              <div class="participant-role text-muted">&lt;cargo 3&gt;</div>
            </div>
            <div style="flex:1; min-width:180px; text-align:center;">
              <div style="height:40px; border-bottom:1px solid #000; margin-bottom:6px;"></div>
              <div class="participant-name" data-index="3">&lt;participante 4&gt;</div>
              <div class="participant-role text-muted">&lt;cargo 4&gt;</div>
            </div>
          </div>
        </div>

        <!-- footer/rodapé com numeração e nota -->
        <div class="doc-footer" style="margin-top:50px; font-size:0.9em; color:#444;">
          <div style="border-top:1px solid #eee; padding-top:6px;">
            <span>(ATA ESCOLAR nº <span id="footer-numero"></span> — página <span class="pageNumber"></span>)</span>
          </div>
        </div>
      </div>
      <!-- fim documento -->

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script type="text/javascript">
  (function(){
    const ataId = {{ ata_id|int }};
    const urlApi = `/formularios/atas/api/ata/${ataId}`;

    function setText(id, txt) {
      const el = document.getElementById(id);
      if (el) el.textContent = txt || "";
    }

    function setParticipant(idx, nome, cargo) {
      const selName = document.querySelector('.participant-name[data-index="'+idx+'"]');
      const selRole = selName ? selName.parentElement.querySelector('.participant-role') : null;
      if (selName) selName.textContent = nome || "";
      if (selRole) selRole.textContent = cargo || "";
    }

    async function loadData() {
      try {
        const res = await fetch(urlApi, {cache: "no-store"});
        if (!res.ok) {
          console.error("API ATA retornou erro", res.status);
          return;
        }
        const data = await res.json();
        // mapear campos
        setText('doc-numero', data.numero || (data.id ? String(data.id) : ""));
        setText('footer-numero', data.numero || (data.id ? String(data.id) : ""));
        setText('doc-aluno', (data.aluno && (data.aluno.nome || data.aluno.Nome)) || data.aluno_nome || data.aluno || "");
        setText('doc-responsavel', data.responsavel || data.responsavel_nome || "");
        const serie = data.serie || data.serie_turma || data.serie_turma || "";
        const turma = data.turma || data.turma_nome || "";
        setText('doc-serie-turma', (serie || "") + (turma ? " / " + turma : ""));
        // relato
        const relatoEl = document.getElementById('doc-relato');
        if (relatoEl) relatoEl.textContent = data.relato || data.descricao || "";

        // participantes: try data.participants_json or participants
        let parts = [];
        if (Array.isArray(data.participants_json)) parts = data.participants_json;
        else if (Array.isArray(data.participants)) parts = data.participants;
        // preencher até 4
        for (let i=0;i<4;i++) {
          const p = parts[i] || {};
          setParticipant(i, p.nome || p.name || p.nome_participante || "", p.cargo || p.role || p.cargo_participante || "");
        }
      } catch (e) {
        console.debug("Erro ao carregar ATA JSON:", e);
      }
    }

    // print button
    const btnPrint = document.getElementById('btn-print');
    if (btnPrint) {
      btnPrint.addEventListener('click', () => {
        window.print();
      });
    }

    // preencher contador de página no footer usando CSS counter for printed PDF
    // também atualiza .pageNumber se possível (some browsers won't update before printing)
    function updatePageNumber() {
      const els = document.querySelectorAll('.pageNumber');
      for (const el of els) el.textContent = "";
    }

    // load now
    loadData();
    updatePageNumber();

  })();
</script>

<style>
/* estilos de impressão simples; o Chromium (pyppeteer) respeita @page e counter(page) */
@media print {
  body { background: white; color: black; }
  .document-view { padding: 20mm; }
  .doc-footer { position: fixed; bottom: 10mm; left: 0; right: 0; text-align: center; }
  /* page counter */
  .pageNumber::after { content: counter(page); }
}
/* for screen view, adicionar borda leve e limitar largura */
.document-view { background: white; border: 1px solid #eee; width: 100%; max-width: 820px; margin: 0 auto; }
</style>
{% endblock %}

