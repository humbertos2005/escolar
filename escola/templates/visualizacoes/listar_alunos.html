{% extends 'base.html' %}
{% block content %}
<h2>Visualização de Alunos</h2>
<div class="toolbar">
    <div class="toolbar-left" style="display:flex; gap:8px; align-items:center;">
        {% if is_admin %}
        <!-- Botão Selecionar Todos (apenas admin) -->
        <button type="button" id="btn-selecionar-todos" class="button btn-outline-primary btn-sm">
            <i class="fas fa-check-square"></i> Selecionar Todos
        </button>

        <!-- Botão Excluir Selecionados (apenas admin) -->
        <button type="button" id="btn-excluir-selecionados" class="button btn-danger btn-sm d-none" title="Excluir alunos selecionados">
            <i class="fas fa-trash"></i> Excluir Selecionados
        </button>
        {% endif %}
    </div>

    <div class="toolbar-right">
        <form method="GET" class="search-form">
            <input type="text" name="search" placeholder="Buscar por nome ou matrícula..." 
                   value="{{ search }}" class="search-input">
            <button type="submit" class="button">
                <i class="fas fa-search"></i> Buscar
            </button>
            {% if search %}
            <a href="{{ url_for('visualizacoes_bp.listar_alunos') }}" class="button btn-secondary">
                <i class="fas fa-times"></i> Limpar
            </a>
            {% endif %}
        </form>
    </div>
</div>

{% if alunos %}
    <div class="table-info">
        <p>Exibindo {{ alunos|length }} aluno(s) - Página {{ page }} de {{ total_pages }}</p>
    </div>
    <div class="table-container">
        <table class="table table-data table-full">
            <thead>
                <tr>
                    {% if is_admin %}
                    <!-- Coluna de seleção (apenas admin) -->
                    <th style="width:40px; text-align:center;">
                        <input type="checkbox" id="select-all-checkbox" aria-label="Selecionar todos">
                    </th>
                    {% endif %}
                    <th>ID</th>
                    <th>Matrícula</th>
                    <th style="min-width: 250px;">Nome Completo</th>
                    <th>Série</th>
                    <th>Turma</th>
                    <th>Turno</th>
                    <th style="min-width: 200px;">Pai</th>
                    <th style="min-width: 200px;">Mãe</th>
                    <th style="min-width: 200px;">Responsável</th>
                    <th style="min-width: 140px;">Telefone 1</th>
                    <th style="min-width: 140px;">Telefone 2</th>
                    <th style="min-width: 140px;">Telefone 3</th>
                    <th style="min-width: 200px;">E-mail</th>
                    <th style="min-width: 300px;">Endereço</th>
                    <th style="min-width: 150px;">Bairro</th>
                    <th style="min-width: 150px;">Cidade</th>
                    <th>Estado</th>
                    {% if is_admin %}
                    <th style="min-width:220px;">Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for aluno in alunos %}
                <tr id="aluno-row-{{ aluno.id }}" data-aluno-id="{{ aluno.id }}" data-aluno-nome="{{ aluno.nome }}">
                    {% if is_admin %}
                    <!-- Checkbox por linha (apenas admin)-->
                    <td class="align-middle text-center">
                        <input type="checkbox" class="select-aluno" data-id="{{ aluno.id }}" data-nome="{{ aluno.nome }}" aria-label="Selecionar aluno {{ aluno.nome }}">
                    </td>
                    {% endif %}
                    <td>{{ aluno.id }}</td>
                    <td><strong>{{ aluno.matricula }}</strong></td>
                    <td><div class="text-left">{{ aluno.nome }}</div></td>
                    <td>{{ aluno.serie or '-' }}</td>
                    <td>{{ aluno.turma or '-' }}</td>
                    <td>{{ aluno.turno or '-' }}</td>
                    <td><div class="text-left">{{ aluno.pai or '-' }}</div></td>
                    <td><div class="text-left">{{ aluno.mae or '-' }}</div></td>
                    <td><div class="text-left">{{ aluno.responsavel or '-' }}</div></td>
                    <td><div class="text-left small-text">{{ aluno.telefone_1 }}</div></td>
                    <td><div class="text-left small-text">{{ aluno.telefone_2 }}</div></td>
                    <td><div class="text-left small-text">{{ aluno.telefone_3 }}</div></td>
                    <td><div class="text-left small-text">{{ aluno.email or '-' }}</div></td>
                    <td>
                        <div class="text-left small-text">
                            {% if aluno.rua %}
                                {{ aluno.rua }}{% if aluno.numero %}, {{ aluno.numero }}{% endif %}{% if aluno.complemento %} - {{ aluno.complemento }}{% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </td>
                    <td><div class="text-left">{{ aluno.bairro or '-' }}</div></td>
                    <td><div class="text-left">{{ aluno.cidade or '-' }}</div></td>
                    <td>{{ aluno.estado or '-' }}</td>
                    {% if is_admin %}
                    <td>
                        <div style="display:flex; gap:8px; justify-content:center; align-items:center;">
                            <button type="button"
                                    class="button btn-secondary btn-upload"
                                    data-aluno-id="{{ aluno.id }}"
                                    title="Enviar/Alterar Foto">
                                <i class="fas fa-camera"></i> Foto
                            </button>

                            <a href="{{ url_for('alunos_bp.editar_aluno', aluno_id=aluno.id) }}" class="button btn-primary" title="Editar Dados">
                                <i class="fas fa-edit"></i> Editar
                            </a>

                            <button type="button"
                                    class="button btn-info btn-view"
                                    data-aluno-id="{{ aluno.id }}"
                                    title="Visualizar Dados">
                                <i class="fas fa-eye"></i> Visualizar
                            </button>

                            <form method="POST" action="{{ url_for('visualizacoes_bp.excluir_aluno', aluno_id=aluno.id) }}" style="display:inline;" onsubmit="return confirm('Confirma a exclusão do aluno {{ aluno.nome }} (ID: {{ aluno.id }})?');">
                                <button type="submit" class="button btn-danger" title="Excluir Aluno">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </form>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="{{ url_for('visualizacoes_bp.listar_alunos', page=page-1, search=search) }}" class="page-link">
            <i class="fas fa-chevron-left"></i> Anterior
        </a>
        {% endif %}
        <span class="page-info">Página {{ page }} de {{ total_pages }}</span>
        {% if page < total_pages %}
        <a href="{{ url_for('visualizacoes_bp.listar_alunos', page=page+1, search=search) }}" class="page-link">
            Próxima <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <i class="fas fa-users"></i>
        <p>Nenhum aluno encontrado{% if search %} com o termo "{{ search }}"{% endif %}.</p>
    </div>
{% endif %}

<div id="modal-view-aluno" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="modal-close" id="close-view-modal">&times;</span>
        <button type="button" class="button btn-secondary" id="btn-sair-modal-view" style="margin-bottom:15px;">Sair</button>
        <h3>Visualizar Aluno</h3>
        <div id="view-aluno-body">
            <!-- Conteúdo preenchido por JS -->
        </div>
    </div>
</div>

{% if is_admin %}
<!-- Modal: Upload Foto -->
<div id="modal-upload-photo" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="modal-close" id="close-upload-modal">&times;</span>
        <h3>Enviar Foto do Aluno</h3>
        <div id="upload-body">
            <form id="form-upload-photo" enctype="multipart/form-data" method="post" onsubmit="return false;">
                <input type="file" id="photo-file" name="photo" accept="image/*" required>
                <input type="hidden" id="upload-aluno-id" name="aluno_id">
                <div style="margin-top:12px;">
                    <button type="button" id="btn-submit-photo" class="button btn-success"><i class="fas fa-upload"></i> Enviar Foto</button>
                    <button type="button" class="button btn-secondary" id="btn-cancel-upload">Cancelar</button>
                </div>
            </form>
            <div id="current-photo" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<!-- Modal: Confirmação de exclusão em massa -->
<div id="confirmExcluirAlunosModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="modal-close" id="close-confirm-modal">&times;</span>
        <h3>Confirmar exclusão</h3>
        <div>
            <p id="confirmExcluirAlunosIntro">Você está prestes a excluir os seguintes alunos:</p>
            <ul id="confirmExcluirAlunosList" style="max-height:280px; overflow:auto; margin-left:16px;"></ul>
            <p id="confirmExcluirAlunosExtra" class="text-muted"></p>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
            <button type="button" id="confirmExcluirCancel" class="button btn-secondary">Cancelar</button>
            <button type="button" id="confirmExcluirProceed" class="button btn-danger">Excluir</button>
        </div>
    </div>
</div>
{% endif %}

<!-- Elemento com rotas para uso em JS (evita Jinja dentro de strings JS) -->
{% if is_admin %}
<div id="routes" 
     data-visualizar-url="{{ url_for('visualizacoes_bp.visualizar_aluno', aluno_id=0) }}" 
     data-upload-url="{{ url_for('visualizacoes_bp.upload_foto', aluno_id=0) }}"
     data-excluir-selecionados-url="{{ url_for('visualizacoes_bp.excluir_alunos_selecionados') }}"
     style="display:none;"></div>
{% else %}
<div id="routes"
     data-visualizar-url="{{ url_for('visualizacoes_bp.visualizar_aluno', aluno_id=0) }}"
     style="display:none;"></div>
{% endif %}

<style>
/* estilos mantidos (sem alterações relevantes) */
.toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap:20px; flex-wrap:wrap; }
.toolbar-left { display:flex; gap:10px; align-items:center; }
.toolbar-right { display:flex; gap:10px; align-items:center; }
.search-form { display:flex; gap:10px; }
.search-input { padding:8px 15px; border:2px solid #e0e0e0; border-radius:5px; font-size:1em; min-width:250px; }
.search-input:focus { outline:none; border-color:#3498db; }
.table-info { color:#7f8c8d; margin-bottom:10px; font-weight:600; }
.table-container { background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:20px; overflow-x:auto; max-height: calc(100vh - 350px); }
.table { width:100%; border-collapse:collapse; margin:0; }
.table-full { min-width: 3000px; }
.table th, .table td { border:1px solid #e0e0e0; padding:12px 10px; text-align:center; vertical-align:middle; white-space:nowrap; }
.table th { background:#2c3e50; color:white; font-weight:600; text-transform:uppercase; font-size:0.8em; position:sticky; top:0; z-index:10; }
.table tbody tr:hover { background:#f8f9fa; }
.table tbody tr:nth-child(even) { background:#fafafa; }
.table tbody tr:nth-child(even):hover { background:#f0f0f0; }
.text-left { text-align:left !important; white-space:normal; word-wrap:break-word; max-width:300px; }
.small-text { font-size:0.85em; line-height:1.3; }
.modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:10000; }
.modal-content { width: 720px; max-width:95%; background:#fff; padding:20px; border-radius:8px; position:relative; }
.modal-close { position:absolute; right:12px; top:10px; cursor:pointer; font-size:20px; color:#666; }
.modal img { max-width:100%; height:auto; border-radius:6px; }
.page-link { padding:10px 20px; background:#3498db; color:white; text-decoration:none; border-radius:5px; transition:all 0.3s; font-weight:600; }
.page-link:hover { background:#2980b9; transform:translateY(-2px); box-shadow:0 4px 10px rgba(52,152,219,0.3); }
.empty-state { text-align:center; padding:60px 20px; background:white; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
.empty-state i { font-size:4em; color:#bdc3c7; margin-bottom:20px; }
.empty-state p { color:#7f8c8d; font-size:1.2em; margin-bottom:20px; }

/* Pequenos ajustes para checkboxes */
.select-aluno { width:18px; height:18px; }
#select-all-checkbox { width:18px; height:18px; }
.d-none { display:none !important; }

#modal-view-aluno img {
    max-width: 320px;
    max-height: 320px;
    width: auto;
    height: auto;
    display: block;
    margin: 0 auto 16px auto;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}

</style>

{% endblock %}

{% block scripts %}
{{ super() }}
{% if is_admin %}
<script src="{{ url_for('static', filename='js/listar_alunos.js') }}"></script>
{% endif %}
{% endblock %}