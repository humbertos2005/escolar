{% extends 'base.html' %}
{% block content %}
<h2>Relatórios Disciplinares</h2>
<form method="POST" class="form-relatorio">
  <div class="form-group">
    <label for="periodo">Período:</label>
    <select id="periodo" name="periodo" required>
      <option value="semestre1" {% if parametros.periodo=='semestre1' %}selected{% endif %}>Primeiro Semestre (01/01 a 30/06)</option>
      <option value="semestre2" {% if parametros.periodo=='semestre2' %}selected{% endif %}>Segundo Semestre (01/07 a 31/12)</option>
      <option value="personalizado" {% if parametros.periodo=='personalizado' %}selected{% endif %}>Personalizado</option>
      <option value="geral" {% if parametros.periodo=='geral' %}selected{% endif %}>Desde 01/01 até hoje</option>
    </select>
  </div>
  <div id="datas-personalizadas" style="display:none;">
    <label for="data_inicio">Data Início:</label>
    <input type="date" id="data_inicio" name="data_inicio" value="{{ parametros.data_inicio or '' }}">
    <label for="data_fim">Data Fim:</label>
    <input type="date" id="data_fim" name="data_fim" value="{{ parametros.data_fim or '' }}">
  </div>
  <div class="form-group">
    <label for="tipo_falta">Tipo de Falta:</label>
    <select id="tipo_falta" name="tipo_falta" multiple="multiple" style="width:100%">
      {% for falta in faltas_opcoes %}
      <option value="{{ falta }}"
        {% if falta in parametros.tipo_falta %}selected{% endif %}>{{ falta }}</option>
      {% endfor %}
    </select>
    <small>(opcional – selecione uma ou mais faltas pelo número ou descrição)</small>
  </div>
  <button type="submit" class="btn btn-primary">Gerar Relatório</button>
</form>

{% if ocorrencias and ocorrencias|length > 0 %}
<form method="post" action="{{ url_for('relatorios_disciplinares_bp.exportar_pdf') }}" target="_blank" style="display:inline;">
  <input type="hidden" name="periodo" value="{{ parametros.periodo }}">
  <input type="hidden" name="data_inicio" value="{{ parametros.data_inicio }}">
  <input type="hidden" name="data_fim" value="{{ parametros.data_fim }}">
  {% for falta in parametros.tipo_falta %}
    <input type="hidden" name="tipo_falta" value="{{ falta }}">
  {% endfor %}
  <button type="submit" class="btn btn-success mb-3">Exportar PDF</button>
</form>
<form method="post" action="{{ url_for('relatorios_disciplinares_bp.exportar_csv') }}" style="display:inline;">
  <input type="hidden" name="periodo" value="{{ parametros.periodo }}">
  <input type="hidden" name="data_inicio" value="{{ parametros.data_inicio }}">
  <input type="hidden" name="data_fim" value="{{ parametros.data_fim }}">
  {% for falta in parametros.tipo_falta %}
    <input type="hidden" name="tipo_falta" value="{{ falta }}">
  {% endfor %}
  <button type="submit" class="btn btn-info mb-3">Exportar CSV</button>
</form>
<button onclick="window.print()" class="btn btn-secondary mb-3">Imprimir Relatório</button>
<div class="card mt-3">
  <div class="card-header"><strong>Gráfico: Ocorrências por Falta</strong></div>
  <div class="card-body">
    <canvas id="grafico-faltas"></canvas>
  </div>
</div>
{% endif %}

{% if resultado %}
  <div class="alert alert-info mt-4"><strong>{{ resultado }}</strong></div>
{% endif %}

{% if estatisticas and estatisticas|length > 0 %}
<div class="card mt-3">
  <div class="card-header"><strong>Resumo por Tipo de Falta</strong></div>
  <div class="card-body">
    <table class="table table-bordered table-sm">
      <thead><tr>
        <th>Falta</th>
        <th>Quantidade</th>
      </tr></thead>
      <tbody>
      {% for falta, quantidade in estatisticas.items() %}
        <tr>
          <td>{{ falta }}</td>
          <td class="text-center">{{ quantidade }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if ocorrencias and ocorrencias|length > 0 %}
<div class="card mt-4">
  <div class="card-header"><strong>Lista Detalhada das Ocorrências</strong></div>
  <div class="card-body">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Data</th>
          <th>Aluno</th>
          <th>Turma</th>
          <th>Série</th>
          <th>ID Falta</th>
          <th>Natureza</th>
          <th>Descrição da Falta</th>
          <th>Medida Aplicada</th>
        </tr>
      </thead>
      <tbody>
        {% for oc in ocorrencias %}
        <tr>
          <td>{{ oc['data_ocorrencia'] }}</td>
          <td>{{ oc['aluno_nome'] }}</td>
          <td>{{ oc['turma'] }}</td>
          <td>{{ oc['serie'] }}</td>
          <td>{{ oc['falta_id'] }}</td>
          <td>{{ oc['natureza'] }}</td>
          <td>{{ oc['descricao'] }}</td>
          <td>{{ oc['medida_aplicada'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.getElementById('periodo').addEventListener('change', function() {
  document.getElementById('datas-personalizadas').style.display = (this.value === 'personalizado') ? 'block' : 'none';
});
$(document).ready(function() {
  $('#tipo_falta').select2({
    placeholder: "(opcional) — selecione uma ou mais faltas",
    allowClear: true
  });
  if ($('#periodo').val() === 'personalizado') {
    $('#datas-personalizadas').show();
  }

  // Gráfico Chart.js
  var ctx = document.getElementById('grafico-faltas');
  if(ctx){
    var chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [{% for falta, q in estatisticas.items() %}"{{ falta }}",{% endfor %}],
        datasets: [{
          label: "Quantidade",
          data: [{% for falta, q in estatisticas.items() %}{{ q }},{% endfor %}],
          backgroundColor: 'rgba(54, 162, 235, 0.6)'
        }]
      }
    });
  }
});
</script>

<p class="mt-4 text-muted">
  Utilize os filtros acima para consultar todas as ocorrências disciplinares e gerar estatísticas do período desejado.<br>
  Você pode <b>Imprimir</b> ou <b>Exportar PDF/CSV</b>. <br>
  Para ocultar nomes dos alunos na versão "pública", edite/comment a coluna "Aluno" na tabela.
</p>
{% endblock %}