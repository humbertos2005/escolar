{% extends "base.html" %}
{% block title %}Dashboard - Gestão Escolar{% endblock %}

{% block extra_styles %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
}

.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 40px;
    margin: -30px -30px 40px -30px;
    border-radius: 0 0 25px 25px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.dashboard-header h1 {
    margin: 0 0 10px 0;
    font-weight: 300;
    font-size: 2.5rem;
    letter-spacing: 1px;
}

.dashboard-header .subtitle {
    margin: 0;
    opacity: 0.9;
    font-weight: 400;
    font-size: 1.1rem;
}

.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 30px;
}

/* Cards de Estatísticas */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.stat-card {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, rgba(255,255,255,0.8), rgba(255,255,255,0.3));
    z-index: 2;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-card-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.stat-card-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.stat-card-success {
    background: linear-gradient(135deg, #2af598 0%, #009efd 100%);
    color: white;
}

.stat-card-info {
    background: linear-gradient(135deg, #00c6fb 0%, #005bea 100%);
    color: white;
}

.stat-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.stat-icon {
    font-size: 2.5em;
    opacity: 0.9;
}

.stat-title {
    font-size: 1.1rem;
    font-weight: 600;
    opacity: 0.95;
}

.stat-value {
    font-size: 3.5rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 15px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stat-link {
    color: rgba(255,255,255,0.9);
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    text-decoration: none;
    font-size: 0.95rem;
}

.stat-link:hover {
    color: white;
    gap: 12px;
}

.alert {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}

.alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

/* Seção de Conteúdo Principal */
.main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
}

.content-card {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.content-card h3 {
    font-size: 1.4rem;
    color: #2c3e50;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 3px solid #3498db;
    display: flex;
    align-items: center;
    gap: 10px;
}

.content-card h3 i {
    color: #3498db;
}

/* Gráfico */
.chart-container {
    position: relative;
    height: 350px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.chart-wrapper {
    width: 100%;
    max-width: 400px;
    height: 300px;
}

.update-time {
    font-size: 0.85rem;
    color: #7f8c8d;
    margin-top: 15px;
    text-align: center;
}

/* Acesso Rápido */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 18px 20px;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 2px solid transparent;
}

.action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.action-btn i {
    font-size: 1.3rem;
}

.btn-outline-primary {
    background: white;
    color: #3498db;
    border-color: #3498db;
}

.btn-outline-primary:hover {
    background: #3498db;
    color: white;
}

.btn-outline-warning {
    background: white;
    color: #f39c12;
    border-color: #f39c12;
}

.btn-outline-warning:hover {
    background: #f39c12;
    color: white;
}

.btn-outline-danger {
    background: white;
    color: #e74c3c;
    border-color: #e74c3c;
}

.btn-outline-danger:hover {
    background: #e74c3c;
    color: white;
}

.btn-outline-info {
    background: white;
    color: #00c6fb;
    border-color: #00c6fb;
}

.btn-outline-info:hover {
    background: #00c6fb;
    color: white;
}

.btn-outline-dark {
    background: white;
    color: #2c3e50;
    border-color: #2c3e50;
}

.btn-outline-dark:hover {
    background: #2c3e50;
    color: white;
}

.btn-outline-success {
    background: white;
    color: #27ae60;
    border-color: #27ae60;
}

.btn-outline-success:hover {
    background: #27ae60;
    color: white;
}

/* Status de Conexão */
.connection-status {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: rgba(255, 255, 255, 0.95);
    padding: 12px 18px;
    border-radius: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    font-size: 0.9rem;
    color: #555;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    transition: all 0.3s ease;
}

.connection-status i {
    font-size: 1.1rem;
}

.connection-status.online {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.connection-status.offline {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Responsividade */
@media (max-width: 1200px) {
    .main-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .dashboard-header {
        padding: 30px 15px;
        margin: -24px -15px 30px -15px;
    }
    
    .dashboard-header h1 {
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .stat-value {
        font-size: 2.5rem;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .connection-status {
        bottom: 10px;
        right: 10px;
        padding: 10px 15px;
        font-size: 0.85rem;
    }
}

/* Animação de Entrada */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stat-card, .content-card {
    animation: fadeInUp 0.6s ease forwards;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }
.stat-card:nth-child(4) { animation-delay: 0.4s; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Bem-vindo ao Dashboard de Gestão Escolar</h1>
    <p class="subtitle">Visão geral e acesso rápido às principais funcionalidades</p>
</div>

<div class="dashboard-container">
    <!-- Cards de Estatísticas -->
    <div class="stats-grid">
        <!-- Linha 1 -->
        <div class="stat-card stat-card-primary">
            <div class="stat-header">
                <i class="fas fa-users stat-icon"></i>
                <span class="stat-title">Total de Alunos</span>
            </div>
            <div class="stat-value" id="totalAlunos">{{ total_alunos }}</div>
            <a href="{{ url_for('visualizacoes_bp.listar_alunos') }}" class="stat-link">
                Ver Alunos <i class="fas fa-arrow-right"></i>
            </a>
        </div>

        <div class="stat-card stat-card-success">
            <div class="stat-header">
                <i class="fas fa-check-circle stat-icon"></i>
                <span class="stat-title">Ocorrências Tratadas</span>
            </div>
            <div class="stat-value" id="totalOcorrencias">{{ total_ocorrencias }}</div>
            <a href="{{ url_for('disciplinar_bp.listar_ocorrencias') }}" class="stat-link">
                Ver Ocorrências <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        <!-- Linha 2 -->
        <div class="stat-card stat-card-warning">
            <div class="stat-header">
                <i class="fas fa-hourglass-half stat-icon"></i>
                <span class="stat-title">RFOs Pendentes</span>
            </div>
            <div class="stat-value" id="rfosPendentes">{{ rfos_pendentes }}</div>
            <a href="{{ url_for('disciplinar_bp.listar_rfo') }}" class="stat-link">
                Ver RFOs <i class="fas fa-arrow-right"></i>
            </a>
        </div>

        <div class="stat-card stat-card-info">
            <div class="stat-header">
                <i class="fas fa-clipboard-check stat-icon"></i>
                <span class="stat-title">FMDs Registradas</span>
            </div>
            <div class="stat-value" id="totalFmd">{{ total_fmd }}</div>
            <a href="{{ url_for('visualizacoes_bp.listar_fmds') }}" class="stat-link">
                Ver FMDs <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>

    <!-- Grid Principal -->
    <div class="main-grid">
        <!-- Acesso Rápido -->
        <div class="content-card">
            <h3><i class="fas fa-bolt"></i> Acesso Rápido</h3>
            <div class="quick-actions">
                <a href="{{ url_for('alunos_bp.adicionar_aluno') }}" class="action-btn btn-outline-primary">
                    <i class="fas fa-user-plus"></i> Adicionar Aluno
                </a>
                <a href="{{ url_for('disciplinar_bp.registrar_rfo') }}" class="action-btn btn-outline-warning">
                    <i class="fas fa-file-alt"></i> Registrar RFO
                </a>
                {% if session.get('nivel') in [1, 2] %}
                <a href="{{ url_for('disciplinar_bp.registrar_fmd') }}" class="action-btn btn-outline-danger">
                    <i class="fas fa-file-medical"></i> Registrar FMD
                </a>
                <a href="{{ url_for('cadastros_bp.listar_faltas') }}" class="action-btn btn-outline-info">
                    <i class="fas fa-exclamation-triangle"></i> Faltas Disciplinares
                </a>
                <a href="{{ url_for('alunos_bp.importar_alunos') }}" class="action-btn btn-outline-dark">
                    <i class="fas fa-file-import"></i> Importar Alunos
                </a>
                <a href="{{ url_for('formularios_bp.tabela_disciplinar') }}" class="action-btn btn-outline-success">
                    <i class="fas fa-table"></i> Tabela Disciplinar
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="connection-status online" id="connectionStatus">
    <i class="fas fa-wifi"></i> Conectado
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const totalAlunosEl = document.getElementById('totalAlunos');
    const rfosPendentesEl = document.getElementById('rfosPendentes');
    const totalOcorrenciasEl = document.getElementById('totalOcorrencias');
    const totalFmdEl = document.getElementById('totalFmd');
    const updateTimeEl = document.getElementById('updateTime');
    const connectionStatusEl = document.getElementById('connectionStatus');
    
    let currentData = {
        total_alunos: parseInt(totalAlunosEl.textContent),
        rfos_pendentes: parseInt(rfosPendentesEl.textContent),
        total_ocorrencias: parseInt(totalOcorrenciasEl.textContent),
        total_fmd: parseInt(totalFmdEl.textContent)
    };

    // Inicializar Gráfico
    const ctx = document.getElementById('dashboardChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Alunos', 'RFOs Pendentes', 'Ocorrências Tratadas', 'FMDs'],
            datasets: [{
                data: [currentData.total_alunos, currentData.rfos_pendentes, currentData.total_ocorrencias, currentData.total_fmd],
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(240, 147, 251, 0.8)',
                    'rgba(42, 245, 152, 0.8)',
                    'rgba(0, 198, 251, 0.8)'
                ],
                borderColor: [
                    'rgba(102, 126, 234, 1)',
                    'rgba(240, 147, 251, 1)',
                    'rgba(42, 245, 152, 1)',
                    'rgba(0, 198, 251, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#333',
                        font: {
                            size: 13,
                            family: 'Segoe UI'
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255,255,255,0.3)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    displayColors: true
                }
            },
            cutout: '65%'
        }
    });

    function updateTimestamp() {
        const now = new Date();
        updateTimeEl.textContent = now.toLocaleTimeString('pt-BR');
    }

    function fetchDashboardStats() {
        if (!navigator.onLine) return;

        fetch('/api/dashboard_stats')
            .then(response => response.json())
            .then(data => {
                totalAlunosEl.textContent = data.total_alunos;
                rfosPendentesEl.textContent = data.rfos_pendentes;
                totalOcorrenciasEl.textContent = data.total_ocorrencias;
                totalFmdEl.textContent = data.total_fmd;

                chart.data.datasets[0].data = [
                    data.total_alunos,
                    data.rfos_pendentes,
                    data.total_ocorrencias,
                    data.total_fmd
                ];
                chart.update();

                updateTimestamp();
                connectionStatusEl.innerHTML = '<i class="fas fa-wifi"></i> Conectado';
                connectionStatusEl.classList.add('online');
                connectionStatusEl.classList.remove('offline');
            })
            .catch(error => {
                console.error('Erro:', error);
                connectionStatusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> Desconectado';
                connectionStatusEl.classList.add('offline');
                connectionStatusEl.classList.remove('online');
            });
    }

    // Atualizar a cada 30 segundos
    setInterval(fetchDashboardStats, 30000);
    updateTimestamp();
});
</script>
{% endblock %}
