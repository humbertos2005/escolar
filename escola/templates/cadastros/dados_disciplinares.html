{% extends 'base.html' %}
{% block title %}Dados Disciplinares{% endblock %}
{% block content %}
<div class="container-fluid" style="max-width:1200px;">
  <h2>Dados Disciplinares</h2>

  <div class="btn-group mb-3" role="group" aria-label="abas disciplinares">
    <button type="button" class="btn btn-outline-secondary active" data-tab="faltas">Faltas Disciplinares</button>
    <button type="button" class="btn btn-outline-secondary" data-tab="elogios">Elogios</button>
    <button type="button" class="btn btn-outline-secondary" data-tab="bimestres">Bimestres</button>
  </div>

  <!-- Botão Importar Faltas, agora controlado por JS de abas -->
  <div id="btn-importar-faltas" class="mb-3" style="display:flex;gap:12px;">
    <a href="{{ url_for('cadastros_bp.importar_faltas') }}" class="btn btn-success">
        <i class="fas fa-file-upload"></i> Importar Faltas (CSV/Excel)
    </a>
  </div>

  <div id="tabs-container">
    <div id="panel-faltas" style="display:block;">
      <iframe id="iframe-faltas" src="{{ url_for('cadastros_bp.listar_faltas') }}?iframe=1"
              style="width:100%;border:0;min-height:700px" loading="eager"></iframe>
    </div>

    <div id="panel-elogios" style="display:none;">
      <iframe id="iframe-elogios" data-src="{{ url_for('cadastros_bp.listar_elogios') }}?iframe=1"
              style="width:100%;border:0;min-height:700px" loading="lazy"></iframe>
    </div>

    <div id="panel-bimestres" style="display:none;">
      <div class="mb-3" style="display:flex;gap:8px;flex-wrap:wrap;">
        <a href="{{ url_for('bimestres_bp.listar_bimestres') }}" class="btn btn-primary">
          <i class="fas fa-plus"></i> Criar/Configurar Bimestres (novo ano)
        </a>
        <a href="{{ url_for('bimestres_bp.gestao_bimestres') }}" class="btn btn-outline-primary">
          <i class="fas fa-calendar-check"></i> Gestão dos Bimestres
        </a>
      </div>
      <iframe id="iframe-bimestres" data-src="{{ url_for('bimestres_bp.listar_bimestres') }}?iframe=1"
              style="width:100%;border:0;min-height:700px" loading="lazy"></iframe>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  // troca de abas
  function show(tab) {
    document.querySelectorAll('[data-tab]').forEach(b=>{
      b.classList.toggle('active', b.getAttribute('data-tab')===tab);
    });
    ['faltas','elogios','bimestres'].forEach(name=>{
      const panel = document.getElementById('panel-'+name);
      if (!panel) return;
      panel.style.display = (name===tab) ? 'block' : 'none';
      const iframe = document.getElementById('iframe-'+name);
      if (iframe && !iframe.getAttribute('src')) {
        const s = iframe.getAttribute('data-src');
        if (s) iframe.setAttribute('src', s);
      }
      // ajustar altura quando carregado (evento 'load' também faz isso)
      if (iframe && iframe.contentWindow) try { iframe.style.height = Math.max(700, iframe.contentWindow.document.body.scrollHeight + 60) + 'px'; } catch(e){}
    });
    // controla botão importar faltas
    toggleBtnImportar(tab);
  }

  function toggleBtnImportar(tab) {
    var btn = document.getElementById('btn-importar-faltas');
    if (btn) btn.style.display = (tab === 'faltas') ? 'flex' : 'none';
  }

  document.querySelectorAll('[data-tab]').forEach(b=>{
    b.addEventListener('click', function(){ 
      show(this.getAttribute('data-tab')); 
    });
  });

  // ajustar altura quando cada iframe carregar
  ['faltas','elogios','bimestres'].forEach(name=>{
    const f = document.getElementById('iframe-'+name);
    if (!f) return;
    f.addEventListener('load', function(){
      try {
        const h = Math.max(
          this.contentDocument.body.scrollHeight,
          this.contentDocument.documentElement.scrollHeight
        );
        this.style.height = (h + 60) + 'px';
      } catch(e){
        // ignora se cross-origin ou erro
      }
    });
  });

  // ativa tab por ?tab=... e corrige visibilidade do botão ao carregar página
  try {
    const params = new URLSearchParams(window.location.search);
    const t = params.get('tab');
    if (t && ['faltas','elogios','bimestres'].includes(t)) {
      // garantir que o iframe carregue
      const iframe = document.getElementById('iframe-'+t);
      if (iframe && !iframe.getAttribute('src')) {
        const s = iframe.getAttribute('data-src');
        if (s) iframe.setAttribute('src', s);
      }
      show(t);
    } else {
      show('faltas');
    }
  } catch(e){
    show('faltas');
  }
})();
</script>
{% endblock %}