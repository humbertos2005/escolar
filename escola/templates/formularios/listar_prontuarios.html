{% extends 'base.html' %}
{% block title %}Listar Prontuários{% endblock %}
{% block content %}

<h2>Prontuários Cadastrados</h2>

<div class="mb-3 d-flex align-items-center justify-content-between">
  <div>
    <!-- Atualizado para usar o namespace singular registrado no blueprint -->
    <a href="{{ url_for('formularios_prontuario.prontuario') }}" class="btn btn-primary">Novo Prontuário</a>
    {% if session.get('nivel') == 1 %}
      {% if show_deleted %}
        <a href="{{ url_for('formularios_prontuario.listar_prontuarios') }}" class="btn btn-outline-secondary ms-2">Ocultar excluídos</a>
      {% else %}
        <a href="{{ url_for('formularios_prontuario.listar_prontuarios') }}?show_deleted=1" class="btn btn-outline-secondary ms-2">Mostrar excluídos</a>
      {% endif %}
    {% endif %}
  </div>
</div>

<style>
  .pront-table td, .pront-table th { vertical-align: middle; }
  .action-cell .btn { width:100%; }
  .deleted-row { opacity: 0.6; background: #fff5f5; }
  @media (max-width: 576px) {
    .action-cell .btn { font-size: 12px; padding: 6px 8px; }
  }
</style>

{% if prontuarios %}
  <div class="table-scroll-wrapper">
    <table class="table table-striped pront-table">
      <thead>
        <tr>
          <th>Aluno</th>
          <th style="width:160px;">Série / Turma</th>
          <th style="width:110px;">Visualizar</th>
          <th style="width:110px;">Editar</th>
          <th style="width:110px;">Excluir</th>
        </tr>
      </thead>
      <tbody>
        {% for p in prontuarios %}
        <tr id="pront-row-{{ p.id }}" class="{% if p.deleted %}deleted-row{% endif %}">
          <td>
            {% if p.aluno_nome %}
              {{ p.aluno_nome }}
            {% else %}
              {{ p.responsavel or ('Aluno ID: ' ~ p.aluno_id) }}
            {% endif %}
          </td>
          <td>{{ p.serie or '-' }} {{ p.turma or '' }}</td>
          <td class="action-cell">
            <a class="btn btn-sm" style="background:#004bca; color:#fff; font-weight:bold; border:2px solid #003580;" href="{{ url_for('formularios_prontuario.visualizar_prontuario', prontuario_id=p.id) }}">Visualizar</a>
          </td>
          <td class="action-cell">
            <a class="btn btn-sm" style="background:#ffd600; color:#664d00; font-weight:bold; border:2px solid #b29a00;" href="{{ url_for('formularios_prontuario.editar_prontuario', prontuario_id=p.id) }}">Editar</a>
          </td>
          <td class="action-cell">
            {% if p.deleted in [None, '', 0, '0', False] %}
              <button class="btn btn-sm" style="background:#e6002a; color:#fff; font-weight:bold; border:2px solid #900018;" data-id="{{ p.id }}">Excluir</button>
            {% else %}
              <span class="text-muted">Excluído</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="empty-state">
    <p>Nenhum prontuário cadastrado.</p>
  </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  function attachDeleteHandlers() {
    document.querySelectorAll('.btn-delete-pront').forEach(btn => {
      const clone = btn.cloneNode(true);
      btn.parentNode.replaceChild(clone, btn);
    });
    document.querySelectorAll('.btn-delete-pront').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.dataset.id;
        if (!id) return;
        if (!confirm('Confirma exclusão (remoção da listagem) deste prontuário?')) return;
        fetch(`{{ url_for('formularios_prontuario.excluir_prontuario', prontuario_id=0) }}`.replace('/0/', `/${id}/`), {
          method: 'POST',
          headers: {'X-Requested-With':'XMLHttpRequest'}
        })
        .then(r => r.json())
        .then(json => {
          if (json && json.success) {
            const row = document.getElementById(`pront-row-${id}`);
            if (row) row.remove();
            alert('Prontuário marcado como excluído (soft delete).');
          } else {
            alert('Erro ao excluir prontuário.');
          }
        }).catch(err => { console.error(err); alert('Erro ao excluir. Veja o console.'); });
      });
    });
  }
  attachDeleteHandlers();
});
</script>

<!-- padding start (mantém linhas) -->
<!-- pad line 1 -->
<!-- pad line 2 -->
<!-- pad line 3 -->
<!-- pad line 4 -->
<!-- pad line 5 -->
<!-- pad line 6 -->
<!-- pad line 7 -->
<!-- pad line 8 -->
<!-- pad line 9 -->
<!-- pad line 10 -->
<!-- pad line 11 -->
<!-- pad line 12 -->
<!-- pad line 13 -->
<!-- pad line 14 -->
<!-- pad line 15 -->
<!-- pad line 16 -->
<!-- pad line 17 -->
<!-- pad line 18 -->
<!-- pad line 19 -->
<!-- pad line 20 -->
<!-- padding end -->

{% endblock %}