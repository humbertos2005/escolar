{% extends "base.html" %}

{% block title %}Nova ATA - {{ next_number if next_number is defined else "" }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card mt-3">
    <div class="card-body">
      <h3 class="card-title mb-4">{% if ata %}Editar ATA{% else %}Nova ATA{% endif %}</h3>

      {# Prepara valores iniciais a partir de `ata` quando disponível #}
      {% set ata_present = ata is defined and ata %}
      {% set numero_val = ata.numero if ata_present else (next_number if next_number is defined else '') %}
      {% set aluno_nome_val = ata.aluno_nome if ata_present else '' %}
      {% set aluno_id_val = ata.aluno_id if ata_present else '' %}
      {% set responsavel_val = ata.responsavel if ata_present else '' %}
      {% set conteudo_val = ata.conteudo if ata_present else '' %}
      {% set participants_json_val = (ata.participants_json if ata_present and ata.participants_json is defined else '[]') %}

      {# extrai série/turma de forma robusta (prioriza campos separados se existentes, senão tenta separar serie_turma) #}
      {% set serie_val = '' %}
      {% set turma_val = '' %}
      {% if ata_present %}
        {% if ata.serie is defined and ata.serie %}
          {% set serie_val = ata.serie %}
        {% endif %}
        {% if ata.turma is defined and ata.turma %}
          {% set turma_val = ata.turma %}
        {% endif %}
        {% if not serie_val and not turma_val and ata.serie_turma is defined and ata.serie_turma %}
          {% set _parts = ata.serie_turma.split(' - ') %}
          {% if _parts|length > 0 %}{% set serie_val = _parts[0] %}{% endif %}
          {% if _parts|length > 1 %}{% set turma_val = _parts[1] %}{% endif %}
        {% endif %}
      {% endif %}

      <form id="ata-form" method="post" action="{{ request.path }}">
        <div class="mb-3 row">
          <label class="col-sm-2 col-form-label">Número</label>
          <div class="col-sm-4">
            <input type="text" readonly class="form-control" id="numero" name="numero" value="{{ numero_val }}">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Aluno</label>
          <input type="text" id="aluno" name="aluno" class="form-control" autocomplete="off" placeholder="Digite nome do aluno (mín. 3 caracteres)" value="{{ aluno_nome_val }}">
          <div id="aluno-suggestions" class="autocomplete-suggestions d-none"></div>
          <input type="hidden" id="aluno_id" name="aluno_id" value="{{ aluno_id_val }}">
          <input type="hidden" id="aluno_nome" name="aluno_nome" value="{{ aluno_nome_val }}">
        </div>

        <div class="mb-3 row">
          <div class="col-md-4">
            <label class="form-label">Série</label>
            <input type="text" id="serie" name="serie" readonly class="form-control" value="{{ serie_val }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Turma</label>
            <input type="text" id="turma" name="turma" readonly class="form-control" value="{{ turma_val }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Responsável</label>
            <input type="text" id="responsavel" name="responsavel" readonly class="form-control" value="{{ responsavel_val }}">
          </div>
        </div>

        {# Campo escondido que será enviado ao backend (conforme o que o DB espera) #}
        <input type="hidden" id="serie_turma" name="serie_turma" value="{{ ata.serie_turma if ata_present and ata.serie_turma is defined else '' }}">

        <div class="mb-3">
          <label class="form-label">Relato / Conteúdo</label>
          <textarea id="conteudo" name="conteudo" class="form-control" rows="6" placeholder="Descreva o ocorrido...">{{ conteudo_val }}</textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Participantes</label>
          <div id="participants-container">
            <!-- linhas serão inseridas aqui -->
          </div>
          <button type="button" id="add-participant" class="btn btn-outline-primary btn-sm mt-2">+ Adicionar participante</button>
        </div>

        <input type="hidden" id="participants_json" name="participants_json" value='{{ participants_json_val|tojson|safe if participants_json_val is string else (participants_json_val|tojson|safe) }}'>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">Salvar ATA</button>
          <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancelar</a>
        </div>
      </form>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  {# Em vez de injetar {{ ... }} dentro do JS, colocamos os dados no atributo data-... #}
  <div id="ata-data"
     data-alunos='{{ (alunos | default([])) | tojson | safe }}'
     data-participants='{% if participants_json_val is defined and participants_json_val is string %}{{ participants_json_val | safe }}{% else %}{{ (participants_json_val | default([])) | tojson | safe }}{% endif %}'
     style="display:none;"></div>

  <script>
    // Ler os dados JSON a partir dos atributos data-*
    (function () {
      var dataEl = document.getElementById('ata-data');
      try {
        var rawAlunos = dataEl && dataEl.getAttribute('data-alunos') || '[]';
        window.ALUNOS = JSON.parse(rawAlunos);
      } catch (e) {
        window.ALUNOS = [];
      }

      try {
        var rawParts = dataEl && dataEl.getAttribute('data-participants') || '[]';
        window.ATA_PARTICIPANTS = JSON.parse(rawParts);
      } catch (e) {
        window.ATA_PARTICIPANTS = [];
      }
    })();

    // Ao submeter o formulário, garante que combinamos série + turma em serie_turma
    document.addEventListener('DOMContentLoaded', function () {
      var form = document.getElementById('ata-form');
      if (form) {
        form.addEventListener('submit', function (e) {
          var s = (document.getElementById('serie') && document.getElementById('serie').value) || '';
          var t = (document.getElementById('turma') && document.getElementById('turma').value) || '';
          var combined = '';
          if (s && t) combined = s + ' - ' + t;
          else if (s) combined = s;
          else if (t) combined = t;
          document.getElementById('serie_turma').value = combined;
          // participants_json provavelmente já é mantido pelo JS existente (ata_form.js).
        });
      }
    });
  </script>

  <script src="{{ url_for('static', filename='js/ata_form.js') }}"></script>
{% endblock %}

