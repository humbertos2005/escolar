name: Cleanup compiled files & generate manifest

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  cleanup-and-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure .gitignore exists (adds common python ignores if missing)
        run: |
          if [ ! -f .gitignore ]; then
            printf '%s\n' \
              "# Byte-compiled / optimized / DLL files" \
              "__pycache__/" \
              "*.py[cod]" \
              "*$py.class" \
              "" \
              "# Virtual environment" \
              "venv/" \
              ".env/" \
              ".env.local" \
              ".venv/" \
              "" \
              "# Editor/OS files" \
              ".DS_Store" \
              "Thumbs.db" > .gitignore
            git add .gitignore || true
            git commit -m "chore: add .gitignore for python (generated by action) [skip ci]" || true
          fi

      - name: Remove __pycache__ directories and .pyc files
        run: |
          echo "Procurando e removendo pastas __pycache__ e arquivos *.pyc..."
          find . -type d -name '__pycache__' -prune -exec rm -rf {} +
          find . -type f -name '*.pyc' -not -path './.git/*' -delete
          echo "Remoções (exemplo):"
          find . -maxdepth 3 -name '__pycache__' -o -name '*.pyc' | sed -n '1,20p' || true

      - name: Commit removals (if any)
        run: |
          # Evita loop: não commita se o autor for o bot
          if [ "$GITHUB_ACTOR" != "github-actions[bot]" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            if ! git diff --cached --quiet; then
              git commit -m "chore: remove compiled files (__pycache__, *.pyc) and apply .gitignore [skip ci]"
              git push
            else
              echo "Nenhuma remoção detectada — nada a commitar."
            fi
          else
            echo "Triggered by github-actions[bot]; skipping commit to avoid loop."
          fi

      - name: Generate manifest.csv (path,size,sha256)
        run: |
          echo "path,size,sha256" > manifest.csv
          find . -type f -not -path './.git/*' -print0 | while IFS= read -r -d '' f; do
            pf=$(echo "$f" | sed 's|^\./||')
            size=$(stat -c%s "$f" 2>/dev/null || echo 0)
            sha=$(sha256sum "$f" | awk '{print $1}')
            escpath=$(printf '%s' "$pf" | sed 's/"/""/g')
            echo "\"$escpath\",$size,$sha" >> manifest.csv
          done
          head -n 10 manifest.csv || true

      - name: Commit manifest (if changed)
        run: |
          git add manifest.csv || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: add manifest.csv (file list + sha256) [skip ci]" || true
            git push || true
          else
            echo "manifest.csv sem alterações em relação ao repo — nada a commitar"
          fi

      - name: Upload manifest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: manifest.csv
