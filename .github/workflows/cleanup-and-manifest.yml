# Workflow: remove __pycache__/ *.pyc, gera manifest.csv e commita mudanças (usa GITHUB_TOKEN)
name: Cleanup compiled files & generate manifest

on:
  workflow_dispatch:
  push:
    # O job principal só roda se o push NÃO vier do github-actions[bot]
    # (verificação adicional no nível do job). Mantemos push para que possamos rodar
    # automaticamente em casos normais, mas evitamos loops.
    branches: [ main ]

jobs:
  cleanup-and-manifest:
    # evita rodar quando o autor do evento for o bot das Actions (previne loops)
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure .gitignore exists (adds common python ignores if missing)
        run: |
          if [ ! -f .gitignore ]; then
            cat > .gitignore <<'EOF'
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[cod]
*$py.class

# Virtual environment
venv/
.env/
.env.local
.venv/

# Editor/OS files
.DS_Store
Thumbs.db
EOF
            git add .gitignore
            git commit -m "chore: add .gitignore for python (generated by action) [skip ci]" || true
          fi

      - name: Remove __pycache__ directories and .pyc files
        run: |
          # Safety: operate from repo root and avoid removing .git
          echo "Procurando e removendo pastas __pycache__ e arquivos *.pyc..."
          # Find and delete __pycache__ directories
          find . -type d -name '__pycache__' -prune -exec rm -rf {} +
          # Delete .pyc files
          find . -type f -name '*.pyc' -not -path './.git/*' -delete
          # Show a short summary
          echo "Remoções efetuadas (amostra):"
          find . -maxdepth 3 -name '__pycache__' -o -name '*.pyc' | sed -n '1,20p' || true

      - name: Commit removals (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          # Only commit if there are changes staged
          if ! git diff --cached --quiet; then
            git commit -m "chore: remove compiled files (__pycache__, *.pyc) and apply .gitignore [skip ci]"
            git push
          else
            echo "Nenhuma remoção detectada — nada a commitar."
          fi

      - name: Generate manifest.csv (path,size,sha256)
        run: |
          echo "path,size,sha256" > manifest.csv
          # Lista todos os arquivos (exceto .git), calcula size e sha256
          # Usa null-separated names to be safe with spaces
          find . -type f -not -path './.git/*' -print0 | while IFS= read -r -d '' f; do
            # normalize path by removing leading ./ 
            pf=$(echo "$f" | sed 's|^\./||')
            size=$(stat -c%s "$f" 2>/dev/null || echo 0)
            sha=$(sha256sum "$f" | awk '{print $1}')
            # Escape double quotes in path
            escpath=$(printf '%s' "$pf" | sed 's/"/""/g')
            echo "\"$escpath\",$size,$sha" >> manifest.csv
          done
          # Show first lines
          echo "manifest.csv gerado (exemplo):"
          head -n 10 manifest.csv || true

      - name: Commit manifest (if changed)
        run: |
          git add manifest.csv
          if ! git diff --cached --quiet; then
            git commit -m "chore: add manifest.csv (file list + sha256) [skip ci]" || true
            git push
          else
            echo "manifest.csv sem alterações em relação ao repo — nada a commitar"
          fi

      - name: Upload manifest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: manifest.csv
